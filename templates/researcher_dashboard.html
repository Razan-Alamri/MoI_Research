{% extends "base.html" %}

{% block title %}لوحة تحكم الباحث{% endblock %}

{% block content %}
<div class="researcher-wrapper">

    <!-- رأس الصفحة -->
    <div class="researcher-header">
        <!-- يسار: الصورة + الترحيب -->
        <div class="researcher-header-main">
            <div class="researcher-avatar">
                {% if current_user.avatar_file %}
                <img src="{{ url_for('uploaded_avatar', filename=current_user.avatar_file) }}" alt="صورة الباحث">
                {% else %}
                <span class="avatar-initials">
                    {{ (current_user.name_ar or 'باحث')[0] }}
                </span>
                {% endif %}
            </div>

            <div>
                <h1 class="researcher-title">
                    أهلاً، {{ current_user.name_ar or "بك" }}
                </h1>
                <p class="researcher-subtitle">
                    من خلال هذه البوابة يمكنك إدارة أبحاثك ومشاريعك، وتحديث بياناتك كباحث في المنصة.
                </p>
            </div>
        </div>

        <!-- يمين: الأزرار -->
        <div class="researcher-header-actions">
            <a href="{{ url_for('researcher_profile') }}" class="btn-circle btn-profile">
                <i class="bi bi-person-circle"></i>
                ملفي الشخصي
            </a>

            <a href="{{ url_for('researcher_logout') }}" class="btn-circle btn-logout">
                <i class="bi bi-box-arrow-left"></i>
                تسجيل الخروج
            </a>
        </div>
    </div>


    <!-- كروت إحصائية بسيطة -->
    <div class="kpis">
        <div class="kpi">
            <div class="kpi-icon">
                <i class="bi bi-journal-text"></i>
            </div>
            <div class="kpi-body">
                <span>{{ stats.total_researches }}</span>
                <label>أبحاث علمية</label>
            </div>
        </div>
        <div class="kpi">
            <div class="kpi-icon">
                <i class="bi bi-kanban"></i>
            </div>
            <div class="kpi-body">
                <span>{{ stats.total_projects }}</span>
                <label>مشاريع / ابتكارات</label>
            </div>
        </div>
        <div class="kpi">
            <div class="kpi-icon">
                <i class="bi bi-activity"></i>
            </div>
            <div class="kpi-body">
                <span>{{ stats.pending_items }}</span>
                <label>عناصر قيد الإكمال</label>
            </div>
        </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <a href="{{ url_for('researcher_new') }}" class="btn-primary">
            <i class="bi bi-plus-circle"></i>
            إضافة بحث / مشروع جديد
        </a>
    </div>

    <!-- جدول الأبحاث المرتبطة بالباحث -->
    <div class="researcher-table-card" style="margin-top: 18px;">
        <table class="researcher-table">
            <thead>
                <tr>
                    <th>العنوان</th>
                    <th>النوع</th>
                    <th>السنة</th>
                    <th>القطاع</th>
                    <th>السرية</th>
                    <th style="width: 160px;">إجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% if researches or projects %}
                {% for item in researches %}
                <tr>
                    <td class="title-cell">
                        <span class="main-title">{{ item.title }}</span>
                        {% if item.short %}
                        <span class="sub-title">{{ item.short }}</span>
                        {% endif %}
                    </td>
                    <td>بحث</td>
                    <td>{{ item.year or "-" }}</td>
                    <td>{{ item.sector or "-" }}</td>
                    <td>
                        {% if item.confidentiality == "confidential" %}
                        <span class="badge badge-confidential">سري</span>
                        {% else %}
                        <span class="badge badge-public">عام</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('researcher_view', item_id=item.id) }}" class="link-action">
                            <i class="bi bi-eye"></i> عرض
                        </a>
                        |
                        <a href="{{ url_for('researcher_edit', item_id=item.id) }}" class="link-action">
                            <i class="bi bi-pencil-square"></i> تعديل
                        </a>
                    </td>
                </tr>
                {% endfor %}

                {% for item in projects %}
                <tr>
                    <td class="title-cell">
                        <span class="main-title">{{ item.title }}</span>
                        {% if item.short %}
                        <span class="sub-title">{{ item.short }}</span>
                        {% endif %}
                    </td>
                    <td>{{ item.kind or "مشروع" }}</td>
                    <td>{{ item.year or "-" }}</td>
                    <td>{{ item.sector or "-" }}</td>
                    <td>
                        {% if item.confidentiality == "confidential" %}
                        <span class="badge badge-confidential">سري</span>
                        {% else %}
                        <span class="badge badge-public">عام</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('researcher_view', item_id=item.id) }}" class="link-action">
                            <i class="bi bi-eye"></i> عرض
                        </a>
                        |
                        <a href="{{ url_for('researcher_edit', item_id=item.id) }}" class="link-action">
                            <i class="bi bi-pencil-square"></i> تعديل
                        </a>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6" style="text-align:center; padding: 18px;">
                        لا توجد أبحاث أو مشاريع مرتبطة بحسابك حتى الآن.
                        <br>
                        <a href="{{ url_for('researcher_new') }}" class="btn-primary" style="margin-top:10px;">
                            <i class="bi bi-plus-circle"></i>
                            إضافة أول بحث
                        </a>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}